<?php
/**
 * Verifica√ß√£o completa de todas as tabelas do projeto
 */

echo "üîç VERIFICA√á√ÉO COMPLETA DAS TABELAS\n";
echo "===================================\n\n";

try {
    require_once 'config.php';
    $pdo = conectarBD();
    
    echo "üì° Conectado ao banco de dados!\n\n";
    
    // Lista completa de todas as tabelas necess√°rias
    $tabelas_necessarias = [
        'usuarios' => [
            'descricao' => 'Sistema de login e perfis',
            'campos_essenciais' => ['id', 'nome', 'usuario', 'senha', 'email', 'is_admin']
        ],
        'questoes' => [
            'descricao' => 'Banco de quest√µes dos exames',
            'campos_essenciais' => ['id', 'numero_questao', 'tipo_prova', 'enunciado', 'resposta_correta', 'ativa']
        ],
        'sessoes_teste' => [
            'descricao' => 'Controle de sess√µes de teste',
            'campos_essenciais' => ['id', 'usuario_id', 'tipo_prova', 'status', 'pontuacao_final', 'acertos']
        ],
        'respostas_usuario' => [
            'descricao' => 'Respostas individuais dos usu√°rios',
            'campos_essenciais' => ['id', 'sessao_id', 'questao_id', 'resposta_usuario', 'esta_correta']
        ],
        'resultados_testes' => [
            'descricao' => 'Resultados finalizados dos testes',
            'campos_essenciais' => ['id', 'usuario_id', 'sessao_id', 'tipo_prova', 'pontuacao']
        ],
        'badges' => [
            'descricao' => 'Sistema de conquistas/badges',
            'campos_essenciais' => ['id', 'nome', 'descricao', 'icone']
        ],
        'usuario_badges' => [
            'descricao' => 'Badges conquistadas por usu√°rio',
            'campos_essenciais' => ['id', 'usuario_id', 'badge_id', 'data_conquista']
        ],
        'forum_categorias' => [
            'descricao' => 'Categorias do f√≥rum',
            'campos_essenciais' => ['id', 'nome', 'descricao', 'cor', 'icone']
        ],
        'forum_topicos' => [
            'descricao' => 'T√≥picos do f√≥rum',
            'campos_essenciais' => ['id', 'categoria_id', 'titulo', 'conteudo', 'autor_id']
        ],
        'forum_respostas' => [
            'descricao' => 'Respostas do f√≥rum',
            'campos_essenciais' => ['id', 'topico_id', 'conteudo', 'autor_id']
        ],
        'niveis_usuario' => [
            'descricao' => 'Sistema de n√≠veis e experi√™ncia',
            'campos_essenciais' => ['id', 'usuario_id', 'nivel_atual', 'experiencia_total']
        ],
        'configuracoes_sistema' => [
            'descricao' => 'Configura√ß√µes gerais do sistema',
            'campos_essenciais' => ['id', 'chave', 'valor', 'tipo', 'categoria']
        ],
        'logs_sistema' => [
            'descricao' => 'Logs de a√ß√µes do sistema',
            'campos_essenciais' => ['id', 'acao', 'detalhes', 'data_criacao']
        ],
        'logs_acesso' => [
            'descricao' => 'Logs de login/logout',
            'campos_essenciais' => ['id', 'tipo_evento', 'sucesso', 'data_evento']
        ],
        'notificacoes' => [
            'descricao' => 'Sistema de notifica√ß√µes',
            'campos_essenciais' => ['id', 'usuario_id', 'titulo', 'mensagem', 'lida']
        ],
        'historico_experiencia' => [
            'descricao' => 'Hist√≥rico de ganho de experi√™ncia',
            'campos_essenciais' => ['id', 'usuario_id', 'acao', 'xp_ganho']
        ],
        'forum_curtidas' => [
            'descricao' => 'Curtidas do f√≥rum',
            'campos_essenciais' => ['id', 'usuario_id', 'tipo_curtida']
        ],
        'forum_moderacao' => [
            'descricao' => 'Modera√ß√£o do f√≥rum',
            'campos_essenciais' => ['id', 'moderador_id', 'acao', 'data_acao']
        ]
    ];
    
    echo "üìã VERIFICANDO EXIST√äNCIA DAS TABELAS:\n";
    echo "=======================================\n";
    
    $tabelas_existentes = 0;
    $problemas = [];
    
    foreach ($tabelas_necessarias as $tabela => $info) {
        try {
            $stmt = $pdo->query("SHOW TABLES LIKE '$tabela'");
            if ($stmt->rowCount() > 0) {
                echo "‚úÖ $tabela - {$info['descricao']}\n";
                $tabelas_existentes++;
                
                // Verificar campos essenciais
                $stmt = $pdo->query("DESCRIBE $tabela");
                $campos = $stmt->fetchAll(PDO::FETCH_COLUMN);
                
                $campos_faltando = [];
                foreach ($info['campos_essenciais'] as $campo) {
                    if (!in_array($campo, $campos)) {
                        $campos_faltando[] = $campo;
                    }
                }
                
                if (!empty($campos_faltando)) {
                    $problemas[] = "Tabela $tabela: campos faltando - " . implode(', ', $campos_faltando);
                    echo "   ‚ö†Ô∏è Campos faltando: " . implode(', ', $campos_faltando) . "\n";
                }
                
            } else {
                echo "‚ùå $tabela - N√ÉO ENCONTRADA\n";
                $problemas[] = "Tabela $tabela n√£o encontrada";
            }
        } catch (Exception $e) {
            echo "‚ùå $tabela - ERRO: " . $e->getMessage() . "\n";
            $problemas[] = "Erro ao verificar tabela $tabela: " . $e->getMessage();
        }
    }
    
    echo "\nüìä VERIFICANDO DADOS INICIAIS:\n";
    echo "==============================\n";
    
    // Verificar usu√°rios
    $stmt = $pdo->query("SELECT COUNT(*) FROM usuarios");
    $usuarios_count = $stmt->fetchColumn();
    echo "üë§ Usu√°rios: $usuarios_count\n";
    
    if ($usuarios_count >= 2) {
        $stmt = $pdo->query("SELECT usuario, nome, is_admin FROM usuarios ORDER BY is_admin DESC");
        $usuarios = $stmt->fetchAll();
        foreach ($usuarios as $usuario) {
            $tipo = $usuario['is_admin'] ? 'Admin' : 'Usu√°rio';
            echo "   ‚Ä¢ {$usuario['usuario']} - {$usuario['nome']} ($tipo)\n";
        }
    } else {
        $problemas[] = "Poucos usu√°rios cadastrados ($usuarios_count)";
    }
    
    // Verificar quest√µes
    $stmt = $pdo->query("SELECT COUNT(*) FROM questoes");
    $questoes_count = $stmt->fetchColumn();
    echo "\n‚ùì Quest√µes: $questoes_count\n";
    
    if ($questoes_count > 0) {
        $stmt = $pdo->query("SELECT tipo_prova, COUNT(*) as total FROM questoes GROUP BY tipo_prova");
        $questoes_por_tipo = $stmt->fetchAll();
        foreach ($questoes_por_tipo as $tipo) {
            echo "   ‚Ä¢ {$tipo['tipo_prova']}: {$tipo['total']} quest√µes\n";
        }
    } else {
        echo "   ‚ö†Ô∏è Nenhuma quest√£o encontrada - Execute: php seed_questoes.php\n";
    }
    
    // Verificar badges
    $stmt = $pdo->query("SELECT COUNT(*) FROM badges");
    $badges_count = $stmt->fetchColumn();
    echo "\nüèÜ Badges: $badges_count\n";
    
    // Verificar categorias do f√≥rum
    $stmt = $pdo->query("SELECT COUNT(*) FROM forum_categorias");
    $categorias_count = $stmt->fetchColumn();
    echo "\nüí¨ Categorias do f√≥rum: $categorias_count\n";
    
    // Verificar configura√ß√µes
    $stmt = $pdo->query("SELECT COUNT(*) FROM configuracoes_sistema");
    $configs_count = $stmt->fetchColumn();
    echo "\n‚öôÔ∏è Configura√ß√µes do sistema: $configs_count\n";
    
    echo "\n" . str_repeat("=", 50) . "\n";
    echo "üìà RESUMO DA VERIFICA√á√ÉO\n";
    echo str_repeat("=", 50) . "\n\n";
    
    echo "‚úÖ TABELAS ENCONTRADAS: $tabelas_existentes/" . count($tabelas_necessarias) . "\n";
    echo "‚úÖ DADOS INICIAIS:\n";
    echo "   ‚Ä¢ Usu√°rios: $usuarios_count\n";
    echo "   ‚Ä¢ Quest√µes: $questoes_count\n";
    echo "   ‚Ä¢ Badges: $badges_count\n";
    echo "   ‚Ä¢ Categorias f√≥rum: $categorias_count\n";
    echo "   ‚Ä¢ Configura√ß√µes: $configs_count\n";
    
    if (empty($problemas)) {
        echo "\nüéâ ESTRUTURA PERFEITA!\n";
        echo "======================\n";
        echo "‚úÖ Todas as tabelas necess√°rias est√£o presentes\n";
        echo "‚úÖ Todos os campos essenciais est√£o corretos\n";
        echo "‚úÖ Dados iniciais carregados\n";
        echo "‚úÖ Sistema pronto para colaboradores\n\n";
        
        echo "üöÄ COMANDOS PARA COLABORADORES:\n";
        echo "===============================\n";
        echo "1. git clone [repositorio]\n";
        echo "2. cd DayDreaming\n";
        echo "3. php setup_database.php\n";
        echo "4. php seed_questoes.php\n";
        echo "5. php -S localhost:8080\n";
        echo "6. Acesse http://localhost:8080\n";
        echo "7. Login: admin / admin123\n\n";
        
    } else {
        echo "\n‚ö†Ô∏è PROBLEMAS ENCONTRADOS:\n";
        echo "=========================\n";
        foreach ($problemas as $problema) {
            echo "‚Ä¢ $problema\n";
        }
        
        echo "\nüîß A√á√ïES RECOMENDADAS:\n";
        echo "======================\n";
        echo "1. Execute: php setup_database.php\n";
        echo "2. Execute: php seed_questoes.php\n";
        echo "3. Verifique novamente: php verificar_tabelas_completas.php\n\n";
    }
    
    echo "üìã LISTA COMPLETA DE TABELAS:\n";
    echo "=============================\n";
    foreach ($tabelas_necessarias as $tabela => $info) {
        echo "‚Ä¢ $tabela - {$info['descricao']}\n";
    }
    
    echo "\nüìû SUPORTE:\n";
    echo "===========\n";
    echo "‚Ä¢ SETUP_COLABORADORES.md - Guia completo\n";
    echo "‚Ä¢ setup_database.php - Configura√ß√£o autom√°tica\n";
    echo "‚Ä¢ seed_questoes.php - Carregamento de quest√µes\n";
    echo "‚Ä¢ verificar_instalacao.php - Diagn√≥stico geral\n";
    
} catch (Exception $e) {
    echo "‚ùå ERRO GERAL: " . $e->getMessage() . "\n";
    echo "Arquivo: " . $e->getFile() . "\n";
    echo "Linha: " . $e->getLine() . "\n\n";
    
    echo "üîß POSS√çVEIS SOLU√á√ïES:\n";
    echo "======================\n";
    echo "1. Verifique se o MySQL est√° rodando\n";
    echo "2. Confirme as credenciais no config.php\n";
    echo "3. Execute: php setup_database.php\n";
    echo "4. Verifique permiss√µes de acesso ao banco\n";
}
?>

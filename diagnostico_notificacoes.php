<?php
/**
 * Diagn√≥stico Completo do Sistema de Notifica√ß√µes
 * Verifica tabelas, funcionalidades e testa o sistema
 */

require_once 'config.php';
iniciarSessaoSegura();

echo "üîî DIAGN√ìSTICO COMPLETO - SISTEMA DE NOTIFICA√á√ïES\n";
echo "=================================================\n\n";

try {
    $pdo = conectarBD();
    echo "‚úÖ Conectado ao banco de dados\n\n";
    
    // 1. Verificar tabela de notifica√ß√µes
    echo "üìã 1. VERIFICANDO TABELA DE NOTIFICA√á√ïES:\n";
    echo "==========================================\n";
    
    $stmt = $pdo->query("SHOW TABLES LIKE 'notificacoes_usuario'");
    if ($stmt->rowCount() > 0) {
        echo "‚úÖ Tabela notificacoes_usuario existe\n";
        
        // Verificar estrutura
        $stmt = $pdo->query("DESCRIBE notificacoes_usuario");
        $colunas = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        echo "üìä Estrutura da tabela:\n";
        foreach ($colunas as $coluna) {
            echo "  - {$coluna['Field']} ({$coluna['Type']})\n";
        }
        
        // Verificar dados
        $stmt = $pdo->query("SELECT COUNT(*) as total FROM notificacoes_usuario");
        $total = $stmt->fetchColumn();
        echo "\nüìà Total de notifica√ß√µes: $total\n";
        
    } else {
        echo "‚ùå Tabela notificacoes_usuario N√ÉO existe\n";
        echo "üîß Solu√ß√£o: Execute php criar_tabela_perfil_usuario.php\n";
    }
    
    // 2. Verificar arquivos do sistema
    echo "\nüìã 2. VERIFICANDO ARQUIVOS DO SISTEMA:\n";
    echo "======================================\n";
    
    $arquivos_necessarios = [
        'sistema_notificacoes.php' => 'Classe principal do sistema',
        'ajax_notificacoes.php' => 'Handler AJAX para a√ß√µes',
        'componente_notificacoes.php' => 'Componente para header',
        'todas_notificacoes.php' => 'P√°gina de todas as notifica√ß√µes'
    ];
    
    foreach ($arquivos_necessarios as $arquivo => $descricao) {
        if (file_exists($arquivo)) {
            echo "‚úÖ $arquivo - $descricao\n";
        } else {
            echo "‚ùå $arquivo - $descricao (FALTANDO)\n";
        }
    }
    
    // 3. Testar classe SistemaNotificacoes
    echo "\nüìã 3. TESTANDO CLASSE SISTEMANOTIFICACOES:\n";
    echo "==========================================\n";
    
    if (file_exists('sistema_notificacoes.php')) {
        require_once 'sistema_notificacoes.php';
        
        try {
            $sistema = new SistemaNotificacoes();
            echo "‚úÖ Classe SistemaNotificacoes instanciada\n";
            
            // Simular usu√°rio logado para testes
            if (!isset($_SESSION['usuario_id'])) {
                $stmt = $pdo->prepare("SELECT id FROM usuarios WHERE usuario = 'teste' LIMIT 1");
                $stmt->execute();
                $user = $stmt->fetch();
                if ($user) {
                    $_SESSION['usuario_id'] = $user['id'];
                    echo "‚úÖ Usu√°rio teste simulado para testes\n";
                }
            }
            
            $usuario_id = $_SESSION['usuario_id'] ?? 1;
            
            // Testar m√©todos principais
            echo "\nüîç Testando m√©todos:\n";
            
            // Contar notifica√ß√µes n√£o lidas
            $nao_lidas = $sistema->contarNotificacoesNaoLidas($usuario_id);
            echo "‚úÖ contarNotificacoesNaoLidas(): $nao_lidas notifica√ß√µes\n";
            
            // Buscar notifica√ß√µes n√£o lidas
            $notificacoes = $sistema->buscarNotificacoesNaoLidas($usuario_id, 5);
            echo "‚úÖ buscarNotificacoesNaoLidas(): " . count($notificacoes) . " notifica√ß√µes\n";
            
            // Buscar todas as notifica√ß√µes
            $todas = $sistema->buscarTodasNotificacoes($usuario_id, 10);
            echo "‚úÖ buscarTodasNotificacoes(): " . count($todas) . " notifica√ß√µes\n";
            
        } catch (Exception $e) {
            echo "‚ùå Erro ao testar classe: " . $e->getMessage() . "\n";
        }
    } else {
        echo "‚ùå Arquivo sistema_notificacoes.php n√£o encontrado\n";
    }
    
    // 4. Criar notifica√ß√µes de exemplo
    echo "\nüìã 4. CRIANDO NOTIFICA√á√ïES DE EXEMPLO:\n";
    echo "======================================\n";
    
    if (isset($sistema) && isset($usuario_id)) {
        // Criar notifica√ß√£o de badge
        try {
            $stmt = $pdo->prepare("
                INSERT INTO notificacoes_usuario (usuario_id, tipo, titulo, mensagem, link, lida)
                VALUES (?, 'badge_conquistada', 'Nova Badge Conquistada!', 'Parab√©ns! Voc√™ conquistou a badge \"Primeiro Teste\"', 'pagina_usuario.php', FALSE)
            ");
            $stmt->execute([$usuario_id]);
            echo "‚úÖ Notifica√ß√£o de badge criada\n";
        } catch (Exception $e) {
            echo "‚ö†Ô∏è Notifica√ß√£o de badge j√° existe ou erro: " . $e->getMessage() . "\n";
        }
        
        // Criar notifica√ß√£o de n√≠vel
        try {
            $stmt = $pdo->prepare("
                INSERT INTO notificacoes_usuario (usuario_id, tipo, titulo, mensagem, link, lida)
                VALUES (?, 'nivel_subiu', 'N√≠vel Aumentado!', 'Voc√™ subiu para o n√≠vel 3! Continue assim!', 'pagina_usuario.php', FALSE)
            ");
            $stmt->execute([$usuario_id]);
            echo "‚úÖ Notifica√ß√£o de n√≠vel criada\n";
        } catch (Exception $e) {
            echo "‚ö†Ô∏è Notifica√ß√£o de n√≠vel j√° existe ou erro: " . $e->getMessage() . "\n";
        }
        
        // Criar notifica√ß√£o de f√≥rum
        try {
            $stmt = $pdo->prepare("
                INSERT INTO notificacoes_usuario (usuario_id, tipo, titulo, mensagem, link, lida)
                VALUES (?, 'forum_resposta', 'Nova Resposta no F√≥rum', 'Algu√©m respondeu ao seu t√≥pico \"D√∫vidas sobre SAT\"', 'forum.php', FALSE)
            ");
            $stmt->execute([$usuario_id]);
            echo "‚úÖ Notifica√ß√£o de f√≥rum criada\n";
        } catch (Exception $e) {
            echo "‚ö†Ô∏è Notifica√ß√£o de f√≥rum j√° existe ou erro: " . $e->getMessage() . "\n";
        }
        
        // Criar notifica√ß√£o de sistema
        try {
            $stmt = $pdo->prepare("
                INSERT INTO notificacoes_usuario (usuario_id, tipo, titulo, mensagem, link, lida)
                VALUES (?, 'sistema', 'Bem-vindo ao DayDreaming!', 'Explore todas as funcionalidades da plataforma', 'index.php', FALSE)
            ");
            $stmt->execute([$usuario_id]);
            echo "‚úÖ Notifica√ß√£o de sistema criada\n";
        } catch (Exception $e) {
            echo "‚ö†Ô∏è Notifica√ß√£o de sistema j√° existe ou erro: " . $e->getMessage() . "\n";
        }
    }
    
    // 5. Testar funcionalidades ap√≥s cria√ß√£o
    echo "\nüìã 5. TESTANDO AP√ìS CRIA√á√ÉO DE EXEMPLOS:\n";
    echo "========================================\n";
    
    if (isset($sistema) && isset($usuario_id)) {
        $nao_lidas_apos = $sistema->contarNotificacoesNaoLidas($usuario_id);
        echo "‚úÖ Notifica√ß√µes n√£o lidas ap√≥s cria√ß√£o: $nao_lidas_apos\n";
        
        $notificacoes_apos = $sistema->buscarNotificacoesNaoLidas($usuario_id, 10);
        echo "‚úÖ Lista de notifica√ß√µes n√£o lidas:\n";
        
        foreach ($notificacoes_apos as $notif) {
            echo "  - [{$notif['tipo']}] {$notif['titulo']}\n";
            echo "    {$notif['mensagem']}\n";
            echo "    Link: " . ($notif['link'] ?? 'Nenhum') . "\n\n";
        }
    }
    
    // 6. Testar AJAX
    echo "\nüìã 6. TESTANDO FUNCIONALIDADE AJAX:\n";
    echo "===================================\n";
    
    if (file_exists('ajax_notificacoes.php')) {
        echo "‚úÖ Arquivo ajax_notificacoes.php existe\n";
        echo "‚úÖ Endpoints dispon√≠veis:\n";
        echo "  - marcar_lida: Marcar notifica√ß√£o como lida\n";
        echo "  - marcar_todas_lidas: Marcar todas como lidas\n";
        echo "  - buscar_notificacoes: Buscar notifica√ß√µes\n";
        echo "  - contar_nao_lidas: Contar n√£o lidas\n";
    } else {
        echo "‚ùå Arquivo ajax_notificacoes.php n√£o encontrado\n";
    }
    
    // 7. Verificar integra√ß√£o com header
    echo "\nüìã 7. VERIFICANDO INTEGRA√á√ÉO COM HEADER:\n";
    echo "=========================================\n";
    
    if (file_exists('header_status.php')) {
        $header_content = file_get_contents('header_status.php');
        
        if (strpos($header_content, 'componente_notificacoes.php') !== false) {
            echo "‚úÖ Header integrado com componente de notifica√ß√µes\n";
        } else {
            echo "‚ö†Ô∏è Header N√ÉO integrado com componente de notifica√ß√µes\n";
            echo "üîß Solu√ß√£o: Adicionar include do componente_notificacoes.php\n";
        }
    }
    
} catch (Exception $e) {
    echo "‚ùå Erro geral: " . $e->getMessage() . "\n";
}

// 8. Resumo e pr√≥ximos passos
echo "\nüìä RESUMO DO DIAGN√ìSTICO:\n";
echo "==========================\n";

$problemas = [];
$sucessos = [];

// Verificar se tabela existe
$stmt = $pdo->query("SHOW TABLES LIKE 'notificacoes_usuario'");
if ($stmt->rowCount() > 0) {
    $sucessos[] = "Tabela notificacoes_usuario existe";
} else {
    $problemas[] = "Tabela notificacoes_usuario n√£o existe";
}

// Verificar arquivos
$arquivos_sistema = ['sistema_notificacoes.php', 'ajax_notificacoes.php', 'componente_notificacoes.php'];
foreach ($arquivos_sistema as $arquivo) {
    if (file_exists($arquivo)) {
        $sucessos[] = "Arquivo $arquivo existe";
    } else {
        $problemas[] = "Arquivo $arquivo n√£o existe";
    }
}

echo "‚úÖ SUCESSOS (" . count($sucessos) . "):\n";
foreach ($sucessos as $sucesso) {
    echo "  - $sucesso\n";
}

if (!empty($problemas)) {
    echo "\n‚ö†Ô∏è PROBLEMAS (" . count($problemas) . "):\n";
    foreach ($problemas as $problema) {
        echo "  - $problema\n";
    }
}

echo "\nüîó PR√ìXIMOS PASSOS:\n";
echo "===================\n";
echo "1. Acesse: http://localhost:8080/todas_notificacoes.php\n";
echo "2. Verifique se as notifica√ß√µes aparecem\n";
echo "3. Teste marcar como lida\n";
echo "4. Verifique contador no header\n";
echo "5. Teste funcionalidades AJAX\n";

echo "\nüß™ P√ÅGINAS PARA TESTAR:\n";
echo "========================\n";
echo "- http://localhost:8080/todas_notificacoes.php (Todas as notifica√ß√µes)\n";
echo "- http://localhost:8080/pagina_usuario.php (Verificar header)\n";
echo "- http://localhost:8080/forum.php (Testar notifica√ß√µes de f√≥rum)\n";

?>
